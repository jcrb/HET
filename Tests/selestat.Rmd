---
title: "Indicateurs de tensions hospitalières"
subtitle: "2015 - 2016"
author: "RESURAL"
date: "31/01/2016"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r global_option, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, width = 80, size = "small")
```


```{r, message = FALSE}
library(Rpu2)
library(lubridate)
source('../het.R')

# lecture du fichier des moyennes
mean.ref <- read.csv("../HET Alsace 2015/het_mean.csv")
rownames(mean.ref) <- mean.ref$X
mean.ref <- mean.ref[order(mean.ref$X),]
mean.ref <- mean.ref[, -1]
names(mean.ref) <- c("ahet1", "ahet2", "ahet3", "ahet4", "ahet5")

# lectures des ecarts-type de référence
sd.ref <- read.csv("../HET Alsace 2015/het_sd.csv")
rownames(sd.ref) <- sd.ref$X
sd.ref <- sd.ref[order(sd.ref$X),]
sd.ref <- sd.ref[, -1]
names(sd.ref) <- c("ahet1", "ahet2", "ahet3", "ahet4", "ahet5")

# lecture des données RPU
load("../../RPU_2016/Data/d16_p.Rda")
dx <- d16.p
# Ajout du mois de décembre 2015
load("../../DATA/RPU_2015/rpu2015d12.Rda") #d12
dx <- rbind(d12, dx)

# calendrier
cal <- seq(min(as.Date(dx$ENTREE)), max(as.Date(dx$ENTREE)), 1)

anc <- 2016

finess <- "Hag"
```

HET1 (nombre de passages)
-------------------------
```{r}
indicateur <- "ahet1"
a <- NULL
for(i in 1:length(cal)){a[i] = het2(dx, finess, cal[i])}

plot(cal, a, type = "l", main = paste(finess, "- Nombre de RPU par jour"), ylab = "Nb. de patients", xlab = anc)

m <- mean.ref[finess, indicateur]
sd <- sd.ref[finess, indicateur]
abline(h = m, col = "green", lty = 2)
abline(h = m + sd, col = "yellow", lty = 2)
abline(h = m + 2 * sd, col = "orange", lty = 2)
abline(h = m + 3 * sd, col = "red", lty = 2)
```


HET2 (nombre de personnes de 75 ans ou plus)
--------------------------------------------
```{r}
indicateur <- "ahet2"
a <- NULL
for(i in 1:length(cal)){a[i] = ahet2(dx, finess, cal[i])}

plot(cal, a, type = "l", main = paste(finess, "- Patients de 75 ans et plus"), ylab = "Nb. de patients", ylim = c(0, max(a) + 10), xlab = anc)

m <- mean.ref[finess, indicateur]
sd <- sd.ref[finess, indicateur]
abline(h = m, col = "green", lty = 2)
abline(h = m + sd, col = "yellow", lty = 2)
abline(h = m + 2 * sd, col = "orange", lty = 2)
abline(h = m + 3 * sd, col = "red", lty = 2)
```

HET3 (durée moyenne de passage)
-------------------------------
```{r}
indicateur <- "ahet3"
m <- mean.ref[finess, indicateur]
sd <- sd.ref[finess, indicateur]

# plante si une date est manquante
z <- unique(as.Date(dx$ENTREE[dx$FINESS == finess]))
# liste des dates manquantes
date.manquante <- NULL
if(setequal(cal, z) == FALSE){
    date.manquante <- as.Date(setdiff(cal, z), origin = "1970-01-01")
}

a <- NULL
for(i in 1:length(cal)){
    if(cal[i] %in% date.manquante)
        a[i] <- 0
    else
        a[i] <- het3(dx, finess, cal[i])
    }

plot(cal, a, type = "l", main = paste(finess, "- Durée moyenne de passage par jour"), ylab = "Temps (minutes)", xlab = anc,  ylim = c(min(a) - 30, max(a) + 30))

abline(h = m, col = "green", lty = 2)
abline(h = m + sd, col = "yellow", lty = 2)
abline(h = m + 2 * sd, col = "orange", lty = 2)
abline(h = m + 3 * sd, col = "red", lty = 2)
```


HET4 (Taux d'hospitalisation)
-----------------------------
```{r}
indicateur <- "ahet4"
m <- mean.ref[finess, indicateur]
sd <- sd.ref[finess, indicateur]

a <- NULL
for(i in 1:length(cal)){a[i] = het4(dx, finess, cal[i])}

plot(cal, a, type = "l", main = paste(finess, "- Taux d'hospitalisation par jour"), ylab = "% hospitalisation", ylim = c(0, max(a, na.rm = TRUE)), xlab = anc)

abline(h = m, col = "green", lty = 2)
abline(h = m + sd, col = "yellow", lty = 2)
abline(h = m + 2 * sd, col = "orange", lty = 2)
abline(h = m + 3 * sd, col = "red", lty = 2)
```


HET5 (charge de soins)
----------------------

```{r}
# charge de soins par jour
indicateur <- "ahet5"

# plante si une date est manquante
z <- unique(as.Date(dx$ENTREE[dx$FINESS == finess]))
# liste des dates manquantes
if(setequal(cal, z) == FALSE){
    date.manquante <- as.Date(setdiff(cal, z), origin = "1970-01-01")
}

a <- NULL
for(i in 1:length(cal)){
    if(cal[i] %in% date.manquante)
        a[i] <- 0
    else
        a[i] <- het5(dx, finess, cal[i])
    }

# Graphe
plot(cal, a, type = "l", main = paste(finess, "- Charge de soins"), ylab = "Nb. de patients présents à 15 h", ylim = c(0, max(a) + 10), xlab = anc)

m <- mean.ref[finess, indicateur]
sd <- sd.ref[finess, indicateur]
abline(h = m, col = "green", lty = 2)
abline(h = m + sd, col = "yellow", lty = 2)
abline(h = m + 2 * sd, col = "orange", lty = 2)
abline(h = m + 3 * sd, col = "red", lty = 2)

```

